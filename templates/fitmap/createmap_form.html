<!DOCTYPE html>
<html>
<head>
	<title>Create a Route</title>
	<meta name="viewport" content="initial-scale=1.0">
	<meta charset="utf-8">
	<style>
		/* Always set the map height explicitly to define the size of the div
		* element that contains the map. */
		#map {
			float: right;
			height: 100%;
			width: 70%
		}
      	/* Optional: Makes the sample page fill the window. */
      	html, body {
			height: 100%;
			margin: 0;
			padding: 10px;
      	}
	</style>
</head>
  	
<body>	
    <div id="map"></div>
 
	<h3><a href="{% url 'homepage-index' %}">Homepage</a></h3>
	<h3><a href="{% url 'admin:index' %}">Admin</a></h3>  

<!-- Action call javascript function, should also redirect or submit form properly -->
		
	<p>Create Route</p>
	Currently, all registered users will be added to the map
	<form action="" id="route_form" method="POST">{%csrf_token %}
		{{ form.as_p }}
		<input type="button" id="create" value="Create Route">
		<input type="submit" id="save" value="Save Route">
	</form>    
	What needs to change:<br>
	<ul>
	<li>Checkboxes for people</li>
	<li>As you click checkboxes on and off, adds people to the map</li>
	<li>You can play around as much as you need, nothing is saved</li>
	<li>Once all done, click save, saves everything and then redirects</li>
  	</ul>
    <script>
    	var result;
    	
    	document.getElementById('save').style.visibility = 'hidden';
      	function initMap() {
			var directionsService = new google.maps.DirectionsService;
			var directionsDisplay = new google.maps.DirectionsRenderer;
	
			var start = document.getElementById('start');
			var end = document.getElementById('end');
			var autocomplete_start = new google.maps.places.Autocomplete(start);
			var autocomplete_end = new google.maps.places.Autocomplete(end);
	
			var map = new google.maps.Map(document.getElementById('map'), {
			  center: {lat: 43.65, lng: -79.38},
			  zoom: 9
			});
			directionsDisplay.setMap(map);
	
			document.getElementById('create').onclick=function() {
				calculateAndDisplayRoute(directionsService, directionsDisplay);
			};
	
			document.forms['route_form'].onsubmit=function() {
				event.preventDefault();
    			saveRoute(map);
			};
		
		}
      	
		function calculateAndDisplayRoute(directionsService, directionsDisplay) {
			directionsService.route({
			  origin: document.getElementById('start').value,
			  destination: document.getElementById('end').value,
			  travelMode: 'WALKING',
			  avoidFerries: true,
			}, function(response, status) {
			  if (status === 'OK') {
				directionsDisplay.setDirections(response);
				document.getElementById('save').style.visibility = 'visible';
				result=response
				//directions=response.routes[0].legs[0];
			  } else {
				window.alert('Directions request failed due to ' + status);
			  }
        	});
        }
 
 		function saveRoute(map) {
 			var legs=result.routes[0].legs[0];
 			var title=document.getElementById('title').value;
 			var data = {'title':title,
						'start_lat': legs.start_location.lat(),
						'start_long': legs.start_location.lng(),
						'end_lat': legs.end_location.lat(),
						'end_long': legs.end_location.lng(),
						};
			$.getJSON("{% url 'createroute_saveroute' %}", data);
			mapRoute(result, map, title);
 		};
 		
 		function mapRoute(result, map, title) {
 		
			var a=0;
			var b=0;
			var c=0;
			var dist=0;
			var olddist=0;
			var latlongs=[];
			var z=0;
			var marker;
			var strokecolor=["#0082c8","#3cb44b","#911eb4","#000080","#46f0f0#","#f58231","#f032e6","#e6beff"];
			var col=0;
			var order=1;

			{% for fitdata in fitdata_all %}

				//Convert route into polylines
				var distance={{fitdata.distance}}*1000;
				var legs=result.routes[0].legs; //legs are point to point
	
				legs:
				for (i = a; i < legs.length; i++) {
					var steps = legs[i].steps; //steps are steps in each leg
					steps:
					for (j=b; j < steps.length; j++) {
						var nextSegment = steps[j].path; //lat and long for each step
						segments:
						for (k=c; k < nextSegment.length; k++) {
//							console.log('leg#:'+i+' of '+legs.length+' step#:'+j+' of '+steps.length+' segment#:'+k+' of '+nextSegment.length);
							//console.log(i+' '+j+' '+k);
							latlongs[z]=nextSegment[k];  //latlongs holds array of lat and long for each step
							if (z>0) {
							olddist=dist;
							dist+= google.maps.geometry.spherical.computeDistanceBetween(latlongs[z],latlongs[z-1]);
			
							}
							if (dist >= distance) {
								break legs;
							}
							z++;

						} //for k
					c=0; //need to go back to zero as you don't want to keep restarting in same position
					} // for j
				b=0; //need to go back to zero as you don't want to keep restarting in same position
				} // for i
	
// 				if (i == legs.length) {
// 					console.log('finished');
// 					console.log(i+' '+j+' '+k);
// 					console.log(legs.length);
// 					}
	
				//Find the exact point where the distance is met
				//Finds the spot along the last polyline
				var percentDist=(distance-olddist)/(dist-olddist);
				var stopSpot = google.maps.geometry.spherical.interpolate(latlongs[z-1],latlongs[z],percentDist);
				latlongs[z]=stopSpot;  

				marker = new google.maps.Marker({
					position: latlongs[0],
					map: map
					});
		
				marker = new google.maps.Marker({
					position: latlongs[z],
					map: map
					});
// Doesn't know what end is	
// 				marker = new google.maps.Marker({
// 					position: end,
// 					map: map
// 					});
	
				var runPath= new google.maps.Polyline({
					path: latlongs,
					strokeColor: strokecolor[col],
					strokeWeight:4
				});

				col++;
				if (col > strokecolor.length) {
					col=0;
					}

				var encodedPath = google.maps.geometry.encoding.encodePath(runPath.getPath());
				encodedPath=encodedPath.replace(/\\/g, "\\\\");
				var data =  {'encodedPath':encodedPath,
							 'fitbiter':'{{fitdata.fitbiter}}',
							 'fitroute':title,
							 'strokecolor':strokecolor[col],
							 'order':order,
							 'num_complete_waypt':i
							 };

				//Django is returning a success variable but not sure how to see it
				//console.log('waypts'+i);
				console.log(data);
				$.getJSON("{% url 'createroute_savemappedroute' %}", data);					


				{% if forloop.first %}
					var first_marker=latlongs[0];
				{% endif %}
	
				//Display the route on the map
				runPath.setMap(map);
	
				//a b c are saved so that it restarts the loops in the position it left
				a=i;
				b=j;
				c=k;
				z=0; 
				latlongs=[];
				latlongs[z]=stopSpot;
				z=1;
				dist=dist-distance;
				order=order+1;
				//console.log('switch'+' a:'+a+' b:'+b+' c:'+c);
			{% endfor %}

			//Make the map the size of the latest route
			var bounds=new google.maps.LatLngBounds();
			bounds.extend(stopSpot);
			bounds.extend(first_marker);
			map.fitBounds(bounds);					

		}
 
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{API_KEY}}&libraries=places&callback=initMap" async defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  </body>
</html>

