<!DOCTYPE html>
<html>
	<head>
		<title>Start a FitMap</title>
    	<meta name="viewport" content="initial-scale=1.0">
    	<meta charset="utf-8">
    	<style>
      	/* Always set the map height explicitly to define the size of the div
        element that contains the map. */
      	#map {
        	height: 75%;
        	width: 75%;
      	}
      	/* Optional: Makes the sample page fill the window. */
      	html, body {
        	height: 100%;
        	margin: 0;
        	padding: 0;
      	}
    	</style>


		<script>		
			// Initiates the Google Map and Creates the Route
			function createRoute() {
			
			  	//Variables for route calculations
				var map = new google.maps.Map(document.getElementById('map'));
			  	var directionsService = new google.maps.DirectionsService();
				var start = {lat: {{fitroute.start.lat}}, lng: {{fitroute.start.long}}};
				var end = {lat: {{fitroute.end.lat}}, lng: {{fitroute.end.long}}};
				var waypts=[
					{% for waypoint in waypoints %}
						{location: new google.maps.LatLng({{waypoint.lat}},{{waypoint.long}}),stopover: true},
					{% endfor %}
							]; //waypts

				var request = {
						   origin: start,
						   destination: end,
						   waypoints: waypts,
						   travelMode: 'WALKING'
						  }; // Request		
						  		
				//Calculate the route
				directionsService.route(request, function(result, status) {
					if (status == 'OK') {
						
						var a=0;
						var b=0;
						var c=0;
						var dist=0;
						var olddist=0;
						var latlongs=[];
						var z=0;
						var marker;
						var strokecolor=["#0082c8","#3cb44b","#911eb4","#000080","#46f0f0#","#f58231","#f032e6","#e6beff"];
						var col=0;
						var order=1;
						
						{% for fitdata in fitdata_all %}
			
							//Convert route into polylines
							var distance={{fitdata.distance}}*1000;
							var legs=result.routes[0].legs; //legs are point to point
							
							legs:
							for (i = a; i < legs.length; i++) {
								var steps = legs[i].steps; //steps are steps in each leg
								steps:
								for (j=b; j < steps.length; j++) {
									var nextSegment = steps[j].path; //lat and long for each step
									segments:
									for (k=c; k < nextSegment.length; k++) {
										console.log('leg#:'+i+' of '+legs.length+' step#:'+j+' of '+steps.length+' segment#:'+k+' of '+nextSegment.length);
										//console.log(i+' '+j+' '+k);
										latlongs[z]=nextSegment[k];  //latlongs holds array of lat and long for each step
										if (z>0) {
										olddist=dist;
										dist+= google.maps.geometry.spherical.computeDistanceBetween(latlongs[z],latlongs[z-1]);
									
										}
										if (dist >= distance) {
											break legs;
										}
										z++;

									} //for k
								c=0; //need to go back to zero as you don't want to keep restarting in same position
								} // for j
							b=0; //need to go back to zero as you don't want to keep restarting in same position
							} // for i
							
							if (i == legs.length) {
								console.log('finished');
								console.log(i+' '+j+' '+k);
								console.log(legs.length);
								}
							
							//Find the exact point where the distance is met
							//Finds the spot along the last polyline
							var percentDist=(distance-olddist)/(dist-olddist);
							var stopSpot = google.maps.geometry.spherical.interpolate(latlongs[z-1],latlongs[z],percentDist);
							latlongs[z]=stopSpot;  

							marker = new google.maps.Marker({
								position: latlongs[0],
								map: map
								});
								
							marker = new google.maps.Marker({
								position: latlongs[z],
								map: map
								});
							
							marker = new google.maps.Marker({
								position: end,
								map: map
								});
							
							var runPath= new google.maps.Polyline({
								path: latlongs,
								strokeColor: strokecolor[col],
								strokeWeight:4
							});
			
							col++;
							if (col > strokecolor.length) {
								col=0;
								}
						
							var encodedPath = google.maps.geometry.encoding.encodePath(runPath.getPath());
							encodedPath=encodedPath.replace(/\\/g, "\\\\");
							var data =  {'encodedPath':encodedPath,
										 'fitbiter':'{{fitdata.fitbiter}}',
										 'fitroute':'{{fitroute.name}}',
										 'strokecolor':strokecolor[col],
										 'order':order,
										 'num_complete_waypt':i
										 };
				
							//Django is returning a success variable but not sure how to see it
							//console.log('waypts'+i);
							$.getJSON("{% url 'savefitmappedrte-view' %}", data);					

						
							{% if forloop.first %}
								var first_marker=latlongs[0];
							{% endif %}
							
							//Display the route on the map
							runPath.setMap(map);
							
							//a b c are saved so that it restarts the loops in the position it left
							a=i;
							b=j;
							c=k;
							z=0; 
							latlongs=[];
							latlongs[z]=stopSpot;
							z=1;
							dist=dist-distance;
							order=order+1;
							//console.log('switch'+' a:'+a+' b:'+b+' c:'+c);
						{% endfor %}
						
						//Make the map the size of the latest route
						var bounds=new google.maps.LatLngBounds();
						bounds.extend(stopSpot);
						bounds.extend(first_marker);
						map.fitBounds(bounds);					
			

						
					} else {     // if status == OK
						console.log('Not Ok');
					}
					
				});  // Close Directions Service Route
				  	
			} // Close Create Route
	

		</script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCGj9lv67pbSIpSh-sZUGCINHE-3H5r_Z8&libraries=geometry,places"></script>
  		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	</head>
	
	<body>
  		<a href="{% url 'homepage-index' %}">Homepage</a>
		<a href="{% url 'admin:index' %}">Admin</a>
		<a href="{% url 'fitdata-index' %}">Fitbit Data</a>
  		
  		<h2>{{fitroute.name}}</h2>
  		<body onload="createRoute()">
  		
  		<div id="map"></div>
  		
  	 </body>	

</html>